(()=>{var e={4586:e=>{"use strict";var t=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=[],i=function(){var e=s.pop();return e||(e={position:new THREE.Vector3,velocity:new THREE.Vector3,scale:new THREE.Vector3,quaternion:new THREE.Quaternion,time:0}),e},o=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.15;n(this,e),this.state=0,this.buffer=[],this.bufferTime=1e3*s,this.time=0,this.mode=t,this.originFrame=i(),this.position=new THREE.Vector3,this.quaternion=new THREE.Quaternion,this.scale=new THREE.Vector3(1,1,1)}return t(e,[{key:"hermite",value:function(e,t,n,s,i,o){var r=t*t,a=t*t*t,c=2*a-3*r+1,h=-2*a+3*r,d=a-2*r+t,l=a-r;e.copy(n.multiplyScalar(c)),e.add(s.multiplyScalar(h)),e.add(i.multiplyScalar(d)),e.add(o.multiplyScalar(l))}},{key:"lerp",value:function(e,t,n,s){e.lerpVectors(t,n,s)}},{key:"slerp",value:function(e,t,n,s){e.slerpQuaternions(t,n,s)}},{key:"updateOriginFrameToBufferTail",value:function(){var e;e=this.originFrame,s.push(e),this.originFrame=this.buffer.shift()}},{key:"appendBuffer",value:function(e,t,n,s){var o=this.buffer.length>0?this.buffer[this.buffer.length-1]:null;if(o&&o.time===this.time)e&&o.position.copy(e),t&&o.velocity.copy(t),n&&o.quaternion.copy(n),s&&o.scale.copy(s);else{var r=o||this.originFrame,a=i();a.position.copy(e||r.position),a.velocity.copy(t||r.velocity),a.quaternion.copy(n||r.quaternion),a.scale.copy(s||r.scale),a.time=this.time,this.buffer.push(a)}}},{key:"setTarget",value:function(e,t,n,s){this.appendBuffer(e,t,n,s)}},{key:"setPosition",value:function(e,t){this.appendBuffer(e,t,null,null)}},{key:"setQuaternion",value:function(e){this.appendBuffer(null,null,e,null)}},{key:"setScale",value:function(e){this.appendBuffer(null,null,null,e)}},{key:"update",value:function(e){if(0===this.state&&this.buffer.length>0&&(this.updateOriginFrameToBufferTail(),this.position.copy(this.originFrame.position),this.quaternion.copy(this.originFrame.quaternion),this.scale.copy(this.originFrame.scale),this.state=1),1===this.state&&this.buffer.length>0&&this.time>this.bufferTime&&(this.state=2),2===this.state){for(var t=this.time-this.bufferTime;this.buffer.length>0&&t>this.buffer[0].time;)this.buffer.length>1?this.updateOriginFrameToBufferTail():(this.originFrame.position.copy(this.buffer[0].position),this.originFrame.velocity.copy(this.buffer[0].velocity),this.originFrame.quaternion.copy(this.buffer[0].quaternion),this.originFrame.scale.copy(this.buffer[0].scale),this.originFrame.time=this.buffer[0].time,this.buffer[0].time=this.time+e);if(this.buffer.length>0&&this.buffer[0].time>0){var n=this.buffer[0],s=n.time-this.originFrame.time,i=(t-this.originFrame.time)/s;0===this.mode?this.lerp(this.position,this.originFrame.position,n.position,i):1===this.mode&&this.hermite(this.position,i,this.originFrame.position,n.position,this.originFrame.velocity.multiplyScalar(s),n.velocity.multiplyScalar(s)),this.slerp(this.quaternion,this.originFrame.quaternion,n.quaternion,i),this.lerp(this.scale,this.originFrame.scale,n.scale,i)}}0!==this.state&&(this.time+=e)}},{key:"getPosition",value:function(){return this.position}},{key:"getQuaternion",value:function(){return this.quaternion}},{key:"getScale",value:function(){return this.scale}}]),e}();e.exports=o},4018:e=>{e.exports=class{constructor(){this.dict={}}addChild(e,t){this.hasParent(e)||(this.dict[e]=[]),this.dict[e].push(t)}getChildren(e){if(!this.hasParent(e))return[];var t=this.dict[e];return delete this.dict[e],t}hasParent(e){return!!this.dict[e]}}},7571:e=>{"use strict";var t=Array.isArray,n=Object.keys,s=Object.prototype.hasOwnProperty;e.exports=function e(i,o){if(i===o)return!0;if(i&&o&&"object"==typeof i&&"object"==typeof o){var r,a,c,h=t(i),d=t(o);if(h&&d){if((a=i.length)!=o.length)return!1;for(r=a;0!=r--;)if(!e(i[r],o[r]))return!1;return!0}if(h!=d)return!1;var l=i instanceof Date,u=o instanceof Date;if(l!=u)return!1;if(l&&u)return i.getTime()==o.getTime();var m=i instanceof RegExp,p=o instanceof RegExp;if(m!=p)return!1;if(m&&p)return i.toString()==o.toString();var f=n(i);if((a=f.length)!==n(o).length)return!1;for(r=a;0!=r--;)if(!s.call(o,f[r]))return!1;for(r=a;0!=r--;)if(!e(i[c=f[r]],o[c]))return!1;return!0}return i!=i&&o!=o}},2956:(e,t,n)=>{var s=n(5492),i=n(7090),o=n(3736),r=n(1056),a=n(6369),c=n(5838),h=n(8729),d={app:"",room:"",clientId:""};d.options=s,d.utils=i,d.log=new o,d.schemas=new r,d.version="0.9.1",d.adapters=new h;var l=new a,u=new c(l);d.connection=u,d.entities=l,e.exports=window.NAF=d},2378:e=>{e.exports=class{notImplemented(e){NAF.log.error("Interface method not implemented:",e)}}},3736:e=>{e.exports=class{constructor(){this.debug=!1}setDebug(e){this.debug=e}write(){this.debug&&console.log.apply(this,arguments)}warn(){console.warn.apply(this,arguments)}error(){console.error.apply(this,arguments)}}},5838:e=>{e.exports=class{constructor(e){this.entities=e,this.setupDefaultDataSubscriptions(),this.connectedClients={},this.activeDataChannels={}}setNetworkAdapter(e){this.adapter=e}setupDefaultDataSubscriptions(){this.dataChannelSubs={},this.dataChannelSubs.u=this.entities.updateEntity.bind(this.entities),this.dataChannelSubs.um=this.entities.updateEntityMulti.bind(this.entities),this.dataChannelSubs.r=this.entities.removeRemoteEntity.bind(this.entities)}connect(e,t,n,s=!1,i=!1){NAF.app=t,NAF.room=n,this.adapter.setServerUrl(e),this.adapter.setApp(t),this.adapter.setRoom(n);var o={audio:s,video:i,datachannel:!0};return this.adapter.setWebRtcOptions(o),this.adapter.setServerConnectListeners(this.connectSuccess.bind(this),this.connectFailure.bind(this)),this.adapter.setDataChannelListeners(this.dataChannelOpen.bind(this),this.dataChannelClosed.bind(this),this.receivedData.bind(this)),this.adapter.setRoomOccupantListener(this.occupantsReceived.bind(this)),this.adapter.connect()}onConnect(e){this.onConnectCallback=e,this.isConnected()?e():document.body.addEventListener("connected",e,!1)}connectSuccess(e){NAF.log.write("Networked-Aframe Client ID:",e),NAF.clientId=e;var t=new CustomEvent("connected",{detail:{clientId:e}});document.body.dispatchEvent(t)}connectFailure(e,t){NAF.log.error(e,"failure to connect")}occupantsReceived(e){var t=Object.assign({},this.connectedClients);this.connectedClients=e,this.checkForDisconnectingClients(t,e),this.checkForConnectingClients(e)}checkForDisconnectingClients(e,t){for(var n in e)t[n]||(NAF.log.write("Closing stream to",n),this.adapter.closeStreamConnection(n))}checkForConnectingClients(e){for(var t in e)this.isNewClient(t)&&this.adapter.shouldStartConnectionTo(e[t])&&(NAF.log.write("Opening datachannel to",t),this.adapter.startStreamConnection(t))}getConnectedClients(){return this.connectedClients}isConnected(){return!!NAF.clientId}isMineAndConnected(e){return this.isConnected()&&NAF.clientId===e}isNewClient(e){return!this.isConnectedTo(e)}isConnectedTo(e){return this.adapter.getConnectStatus(e)===NAF.adapters.IS_CONNECTED}dataChannelOpen(e){NAF.log.write("Opened data channel from "+e),this.activeDataChannels[e]=!0,this.entities.completeSync(e,!0);var t=new CustomEvent("clientConnected",{detail:{clientId:e}});document.body.dispatchEvent(t)}dataChannelClosed(e){NAF.log.write("Closed data channel from "+e),this.activeDataChannels[e]=!1,this.entities.removeEntitiesOfClient(e);var t=new CustomEvent("clientDisconnected",{detail:{clientId:e}});document.body.dispatchEvent(t)}hasActiveDataChannel(e){return!!this.activeDataChannels[e]}broadcastData(e,t){this.adapter.broadcastData(e,t)}broadcastDataGuaranteed(e,t){this.adapter.broadcastDataGuaranteed(e,t)}sendData(e,t,n,s){this.hasActiveDataChannel(e)&&(s?this.adapter.sendDataGuaranteed(e,t,n):this.adapter.sendData(e,t,n))}sendDataGuaranteed(e,t,n){this.sendData(e,t,n,!0)}subscribeToDataChannel(e,t){this.isReservedDataType(e)?NAF.log.error("NetworkConnection@subscribeToDataChannel: "+e+" is a reserved dataType. Choose another"):this.dataChannelSubs[e]=t}unsubscribeToDataChannel(e){this.isReservedDataType(e)?NAF.log.error("NetworkConnection@unsubscribeToDataChannel: "+e+" is a reserved dataType. Choose another"):delete this.dataChannelSubs[e]}isReservedDataType(e){return"u"==e||"r"==e}receivedData(e,t,n,s){this.dataChannelSubs[t]?this.dataChannelSubs[t](e,t,n,s):NAF.log.write("NetworkConnection@receivedData: "+t+" has not been subscribed to yet. Call subscribeToDataChannel()")}getServerTime(){return this.adapter.getServerTime()}disconnect(){this.entities.removeRemoteEntities(),this.adapter&&this.adapter.disconnect(),NAF.app="",NAF.room="",NAF.clientId="",this.connectedClients={},this.activeDataChannels={},this.adapter=null,this.setupDefaultDataSubscriptions(),document.body.removeEventListener("connected",this.onConnectCallback)}}},6369:(e,t,n)=>{var s=n(4018);e.exports=class{constructor(){this.entities={},this.childCache=new s,this.onRemoteEntityCreatedEvent=new Event("remoteEntityCreated"),this._persistentFirstSyncs={}}registerEntity(e,t){this.entities[e]=t}createRemoteEntity(e){NAF.log.write("Creating remote entity",e);var t=e.networkId,n=NAF.schemas.getCachedTemplate(e.template);return this.initPosition(n,e.components),this.initRotation(n,e.components),this.addNetworkComponent(n,e),this.registerEntity(t,n),n}initPosition(e,t){if(t.position){var n=t.position;e.setAttribute("position",n)}}initRotation(e,t){if(t.rotation){var n=t.rotation;e.setAttribute("rotation",n)}}addNetworkComponent(e,t){var n={template:t.template,creator:t.creator,owner:t.owner,networkId:t.networkId,persistent:t.persistent};e.setAttribute("networked",n),e.firstUpdateData=t}updateEntityMulti(e,t,n,s){if(!NAF.options.syncSource||s===NAF.options.syncSource)for(let t=0,i=n.d.length;t<i;t++)this.updateEntity(e,"u",n.d[t],s)}updateEntity(e,t,n,s){if(!NAF.options.syncSource||s===NAF.options.syncSource){var i=n.networkId;this.hasEntity(i)?this.entities[i].components.networked.networkUpdate(n):n.isFirstSync&&!1!==NAF.connection.activeDataChannels[n.owner]&&(NAF.options.firstSyncSource&&s!==NAF.options.firstSyncSource?NAF.log.write("Ignoring first sync from disallowed source",s):n.persistent?this._persistentFirstSyncs[i]=n:this.receiveFirstUpdateFromEntity(n))}}receiveFirstUpdateFromEntity(e){var t=e.parent,n=e.networkId;if(t&&!this.hasEntity(t))this.childCache.addChild(t,e);else{var s=this.createRemoteEntity(e);this.createAndAppendChildren(n,s),this.addEntityToPage(s,t)}}createAndAppendChildren(e,t){for(var n=this.childCache.getChildren(e),s=0;s<n.length;s++){var i=n[s],o=i.networkId;if(this.hasEntity(o))NAF.log.warn("Tried to instantiate entity multiple times",o,i,"Existing entity:",this.getEntity(o));else{var r=this.createRemoteEntity(i);this.createAndAppendChildren(o,r),t.appendChild(r)}}}addEntityToPage(e,t){this.hasEntity(t)?this.addEntityToParent(e,t):this.addEntityToSceneRoot(e)}addEntityToParent(e,t){this.entities[t].appendChild(e)}addEntityToSceneRoot(e){document.querySelector("a-scene").appendChild(e)}completeSync(e,t){for(var n in this.entities)this.entities[n]&&this.entities[n].components.networked.syncAll(e,t)}removeRemoteEntity(e,t,n,s){if(!NAF.options.syncSource||s===NAF.options.syncSource){var i=n.networkId;return this.removeEntity(i)}}removeEntitiesOfClient(e){const t=[];for(var n in this.entities){const s=this.entities[n],i=NAF.utils.getCreator(s),o=NAF.utils.getNetworkOwner(s);if(i===e||!i&&o===e){const e=this.entities[n].getAttribute("networked");e&&e.persistent?NAF.utils.takeOwnership(s):t.push(this.removeEntity(n))}}return t}removeEntity(e){if(this.forgetPersistentFirstSync(e),this.hasEntity(e)){var t=this.entities[e];return this.forgetEntity(e),t.parentNode.removeChild(t),t}return NAF.log.error("Tried to remove entity I don't have."),null}forgetEntity(e){delete this.entities[e],this.forgetPersistentFirstSync(e)}getPersistentFirstSync(e){return this._persistentFirstSyncs[e]}forgetPersistentFirstSync(e){delete this._persistentFirstSyncs[e]}getEntity(e){return this.entities[e]?this.entities[e]:null}hasEntity(e){return!!this.entities[e]}removeRemoteEntities(){for(var e in this.childCache=new s,this.entities)this.entities[e].getAttribute("networked").owner!=NAF.clientId&&this.removeEntity(e)}}},1056:e=>{e.exports=class{constructor(){this.schemaDict={},this.templateCache={}}createDefaultSchema(e){return{template:e,components:["position","rotation"]}}add(e){if(this.validateSchema(e)){this.schemaDict[e.template]=e;var t=document.querySelector(e.template);if(!t)return void NAF.log.error(`Template el not found for ${e.template}, make sure NAF.schemas.add is called after <a-scene> is defined.`);if(!this.validateTemplate(e,t))return;this.templateCache[e.template]=document.importNode(t.content,!0)}else NAF.log.error("Schema not valid: ",e),NAF.log.error("See https://github.com/networked-aframe/networked-aframe#syncing-custom-components")}getCachedTemplate(e){return this.templateIsCached(e)||(this.templateExistsInScene(e)?this.add(this.createDefaultSchema(e)):NAF.log.error(`Template el for ${e} is not in the scene, add the template to <a-assets> and register with NAF.schemas.add.`)),this.templateCache[e].firstElementChild.cloneNode(!0)}templateIsCached(e){return!!this.templateCache[e]}getComponents(e){var t=["position","rotation"];return this.hasTemplate(e)&&(t=this.schemaDict[e].components),t}hasTemplate(e){return!!this.schemaDict[e]}templateExistsInScene(e){var t=document.querySelector(e);return t&&this.isTemplateTag(t)}validateSchema(e){return!(!e.template||!e.components)}validateTemplate(e,t){return this.isTemplateTag(t)?!!this.templateHasOneOrZeroChildren(t)||(NAF.log.error(`Template for ${e.template} has more than one child. Templates must have one direct child element, no more. Template found:`,t),!1):(NAF.log.error(`Template for ${e.template} is not a <template> tag. Instead found: ${t.tagName}`),!1)}isTemplateTag(e){return"template"===e.tagName.toLowerCase()}templateHasOneOrZeroChildren(e){return e.content.childElementCount<2}remove(e){delete this.schemaDict[e]}clear(){this.schemaDict={}}}},8729:(e,t,n)=>{const s=n(4529),i=n(7523),o=n(9984),r=n(3478);class a{constructor(){this.adapters={wseasyrtc:s,easyrtc:i,socketio:r,webrtc:o},this.IS_CONNECTED=a.IS_CONNECTED,this.CONNECTING=a.CONNECTING,this.NOT_CONNECTED=a.NOT_CONNECTED}register(e,t){this.adapters[e]=t}make(e){var t=e.toLowerCase();if(this.adapters[t])return new(0,this.adapters[t]);throw new Error("Adapter: "+e+" not registered. Please use NAF.adapters.register() to register this adapter.")}}a.IS_CONNECTED="IS_CONNECTED",a.CONNECTING="CONNECTING",a.NOT_CONNECTED="NOT_CONNECTED",e.exports=a},7523:(e,t,n)=>{const s=n(6316);e.exports=class extends s{constructor(e){super(),this.easyrtc=e||window.easyrtc,this.app="default",this.room="default",this.mediaStreams={},this.remoteClients={},this.pendingMediaRequests=new Map,this.serverTimeRequests=0,this.timeOffsets=[],this.avgTimeOffset=0,this.easyrtc.setPeerOpenListener((e=>{const t=this.easyrtc.getPeerConnectionByUserId(e);this.remoteClients[e]=t})),this.easyrtc.setPeerClosedListener((e=>{delete this.remoteClients[e];const t=this.pendingMediaRequests.get(e);if(t){const n="The user disconnected before the media stream was resolved.";Object.keys(t).forEach((e=>{t[e].reject(n)})),this.pendingMediaRequests.delete(e)}}))}setServerUrl(e){this.easyrtc.setSocketUrl(e)}setApp(e){this.app=e}setRoom(e){this.room=e,this.easyrtc.joinRoom(e,null)}setWebRtcOptions(e){this.easyrtc.enableDataChannels(e.datachannel),this.easyrtc.enableVideo(e.video),this.easyrtc.enableAudio(e.audio),this.easyrtc.enableVideoReceive(!0),this.easyrtc.enableAudioReceive(!0)}setServerConnectListeners(e,t){this.connectSuccess=e,this.connectFailure=t}setRoomOccupantListener(e){this.easyrtc.setRoomOccupantListener((function(t,n,s){e(n)}))}setDataChannelListeners(e,t,n){this.easyrtc.setDataChannelOpenListener(e),this.easyrtc.setDataChannelCloseListener(t),this.easyrtc.setPeerListener(n)}updateTimeOffset(){const e=Date.now()+this.avgTimeOffset;return fetch(document.location.href,{method:"HEAD",cache:"no-cache"}).then((t=>{var n=new Date(t.headers.get("Date")).getTime()+500,s=Date.now(),i=n+(s-e)/2-s;this.serverTimeRequests++,this.serverTimeRequests<=10?this.timeOffsets.push(i):this.timeOffsets[this.serverTimeRequests%10]=i,this.avgTimeOffset=this.timeOffsets.reduce(((e,t)=>e+t),0)/this.timeOffsets.length,this.serverTimeRequests>10?setTimeout((()=>this.updateTimeOffset()),3e5):this.updateTimeOffset()}))}connect(){Promise.all([this.updateTimeOffset(),new Promise(((e,t)=>{this._connect(e,t)}))]).then((([e,t])=>{this._myRoomJoinTime=this._getRoomJoinTime(t),this.connectSuccess(t)})).catch(this.connectFailure)}shouldStartConnectionTo(e){return this._myRoomJoinTime<=e.roomJoinTime}startStreamConnection(e){this.easyrtc.call(e,(function(e,t){"datachannel"===t&&NAF.log.write("Successfully started datachannel to ",e)}),(function(e,t){NAF.log.error(e,t)}),(function(e){}))}closeStreamConnection(e){this.easyrtc.hangup(e)}sendData(e,t,n){this.easyrtc.sendData(e,t,n)}sendDataGuaranteed(e,t,n){this.easyrtc.sendDataWS(e,t,n)}broadcastData(e,t){var n=this.easyrtc.getRoomOccupantsAsMap(this.room);for(var s in n)n[s]&&s!==this.easyrtc.myEasyrtcid&&this.easyrtc.sendData(s,e,t)}broadcastDataGuaranteed(e,t){var n={targetRoom:this.room};this.easyrtc.sendDataWS(n,e,t)}getConnectStatus(e){var t=this.easyrtc.getConnectStatus(e);return t==this.easyrtc.IS_CONNECTED?NAF.adapters.IS_CONNECTED:t==this.easyrtc.NOT_CONNECTED?NAF.adapters.NOT_CONNECTED:NAF.adapters.CONNECTING}getMediaStream(e,t="audio"){if(this.mediaStreams[e]&&this.mediaStreams[e][t])return NAF.log.write(`Already had ${t} for ${e}`),Promise.resolve(this.mediaStreams[e][t]);{if(NAF.log.write(`Waiting on ${t} for ${e}`),!this.pendingMediaRequests.has(e)){const t={},n=new Promise(((e,n)=>{t.audio={resolve:e,reject:n}})).catch((t=>NAF.log.warn(`${e} getMediaStream Audio Error`,t)));t.audio.promise=n;const s=new Promise(((e,n)=>{t.video={resolve:e,reject:n}})).catch((t=>NAF.log.warn(`${e} getMediaStream Video Error`,t)));t.video.promise=s,this.pendingMediaRequests.set(e,t)}const n=this.pendingMediaRequests.get(e);if(!n[t]){const s=new Promise(((e,s)=>{n[t]={resolve:e,reject:s}})).catch((n=>NAF.log.warn(`${e} getMediaStream "${t}" Error`,n)));n[t].promise=s}return this.pendingMediaRequests.get(e)[t].promise}}setMediaStream(e,t,n){const s=this.pendingMediaRequests.get(e),i=this.mediaStreams[e]=this.mediaStreams[e]||{};if("default"===n){const n=t.getAudioTracks();if(n.length>0){const t=new MediaStream;try{n.forEach((e=>t.addTrack(e))),i.audio=t}catch(t){NAF.log.warn(`${e} setMediaStream "audio" alias Error`,t)}s&&s.audio.resolve(t)}const o=t.getVideoTracks();if(o.length>0){const t=new MediaStream;try{o.forEach((e=>t.addTrack(e))),i.video=t}catch(t){NAF.log.warn(`${e} setMediaStream "video" alias Error`,t)}s&&s.video.resolve(t)}}else i[n]=t,s&&s[n]&&s[n].resolve(t)}addLocalMediaStream(e,t){const n=this.easyrtc;t=t||e.id,this.setMediaStream("local",e,t),n.register3rdPartyLocalMediaStream(e,t),Object.keys(this.remoteClients).forEach((e=>{n.getConnectStatus(e)!==n.NOT_CONNECTED&&n.addStreamToCall(e,t)}))}removeLocalMediaStream(e){this.easyrtc.closeLocalMediaStream(e),delete this.mediaStreams.local[e]}enableMicrophone(e){this.easyrtc.enableMicrophone(e)}enableCamera(e){this.easyrtc.enableCamera(e)}disconnect(){this.easyrtc.disconnect()}_connect(e,t){var n=this;this.easyrtc.setStreamAcceptor(this.setMediaStream.bind(this)),this.easyrtc.setOnStreamClosed((function(e,t,s){"default"===s?(delete n.mediaStreams[e].audio,delete n.mediaStreams[e].video):delete n.mediaStreams[e][s],0===Object.keys(n.mediaStreams[e]).length&&delete n.mediaStreams[e]})),n.easyrtc.audioEnabled||n.easyrtc.videoEnabled?navigator.mediaDevices.getUserMedia({video:n.easyrtc.videoEnabled,audio:n.easyrtc.audioEnabled}).then((function(s){n.addLocalMediaStream(s,"default"),n.easyrtc.connect(n.app,e,t)}),(function(e,t){NAF.log.error(e,t)})):n.easyrtc.connect(n.app,e,t)}_getRoomJoinTime(e){var t=NAF.room;return this.easyrtc.getRoomOccupantsAsMap(t)[e].roomJoinTime}getServerTime(){return Date.now()+this.avgTimeOffset}}},6316:(e,t,n)=>{var s=n(2378);e.exports=class extends s{setServerUrl(e){this.notImplemented("setServerUrl")}setApp(e){this.notImplemented("setApp")}setRoom(e){this.notImplemented("setRoom")}setWebRtcOptions(e){this.notImplemented("setWebRtcOptions")}setServerConnectListeners(e,t){this.notImplemented("setServerConnectListeners")}setRoomOccupantListener(e){this.notImplemented("setRoomOccupantListener")}setDataChannelListeners(e,t,n){this.notImplemented("setDataChannelListeners")}connect(){this.notImplemented("connect")}shouldStartConnectionTo(e){this.notImplemented("shouldStartConnectionTo")}startStreamConnection(e){this.notImplemented("startStreamConnection")}closeStreamConnection(e){this.notImplemented("closeStreamConnection")}getConnectStatus(e){this.notImplemented("getConnectStatus")}getMediaStream(e){return Promise.reject("Interface method not implemented: getMediaStream")}getServerTime(){this.notImplemented("getServerTime")}sendData(e,t,n){this.notImplemented("sendData")}sendDataGuaranteed(e,t,n){this.notImplemented("sendDataGuaranteed")}broadcastData(e,t){this.notImplemented("broadcastData")}broadcastDataGuaranteed(e,t){this.notImplemented("broadcastDataGuaranteed")}disconnect(){this.notImplemented("disconnect")}}},4529:(e,t,n)=>{const s=n(6316);e.exports=class extends s{constructor(e){super(),this.easyrtc=e||window.easyrtc,this.app="default",this.room="default",this.connectedClients=[],this.serverTimeRequests=0,this.timeOffsets=[],this.avgTimeOffset=0}setServerUrl(e){this.serverUrl=e,this.easyrtc.setSocketUrl(e)}setApp(e){this.app=e}setRoom(e){this.room=e,this.easyrtc.joinRoom(e,null)}setWebRtcOptions(e){}setServerConnectListeners(e,t){this.connectSuccess=e,this.connectFailure=t}setRoomOccupantListener(e){this.easyrtc.setRoomOccupantListener((function(t,n,s){e(n)}))}setDataChannelListeners(e,t,n){this.openListener=e,this.closedListener=t,this.easyrtc.setPeerListener(n)}updateTimeOffset(){const e=Date.now()+this.avgTimeOffset;return fetch(document.location.href,{method:"HEAD",cache:"no-cache"}).then((t=>{var n=new Date(t.headers.get("Date")).getTime()+500,s=Date.now(),i=n+(s-e)/2-s;this.serverTimeRequests++,this.serverTimeRequests<=10?this.timeOffsets.push(i):this.timeOffsets[this.serverTimeRequests%10]=i,this.avgTimeOffset=this.timeOffsets.reduce(((e,t)=>e+t),0)/this.timeOffsets.length,this.serverTimeRequests>10?setTimeout((()=>this.updateTimeOffset()),3e5):this.updateTimeOffset()}))}connect(){Promise.all([this.updateTimeOffset(),new Promise(((e,t)=>{this.easyrtc.connect(this.app,e,t)}))]).then((([e,t])=>{this.connectSuccess(t)})).catch(this.connectFailure)}shouldStartConnectionTo(e){return!0}startStreamConnection(e){this.connectedClients.push(e),this.openListener(e)}closeStreamConnection(e){var t=this.connectedClients.indexOf(e);t>-1&&this.connectedClients.splice(t,1),this.closedListener(e)}sendData(e,t,n){this.easyrtc.sendDataWS(e,t,n)}sendDataGuaranteed(e,t,n){this.sendData(e,t,n)}broadcastData(e,t){var n={targetRoom:this.room};this.easyrtc.sendDataWS(n,e,t)}broadcastDataGuaranteed(e,t){this.broadcastData(e,t)}getConnectStatus(e){return-1!=this.connectedClients.indexOf(e)?NAF.adapters.IS_CONNECTED:NAF.adapters.NOT_CONNECTED}getServerTime(){return Date.now()+this.avgTimeOffset}disconnect(){this.easyrtc.disconnect()}}},3478:e=>{e.exports=class{constructor(){void 0===io&&console.warn("It looks like socket.io has not been loaded before SocketioAdapter. Please do that."),this.app="default",this.room="default",this.occupantListener=null,this.myRoomJoinTime=null,this.myId=null,this.occupants={},this.connectedClients=[],this.serverTimeRequests=0,this.timeOffsets=[],this.avgTimeOffset=0}setServerUrl(e){this.wsUrl=e}setApp(e){this.app=e}setRoom(e){this.room=e}setWebRtcOptions(e){}setServerConnectListeners(e,t){this.connectSuccess=e,this.connectFailure=t}setRoomOccupantListener(e){this.occupantListener=e}setDataChannelListeners(e,t,n){this.openListener=e,this.closedListener=t,this.messageListener=n}connect(){const e=this;this.updateTimeOffset().then((()=>{e.wsUrl&&"/"!==e.wsUrl||("https:"===location.protocol?e.wsUrl="wss://"+location.host:e.wsUrl="ws://"+location.host),NAF.log.write("Attempting to connect to socket.io");const t=e.socket=io(e.wsUrl);function n(t){const n=t.from,s=t.type,i=t.data;e.messageListener(n,s,i)}t.on("connect",(()=>{NAF.log.write("User connected",t.id),e.myId=t.id,e.joinRoom()})),t.on("connectSuccess",(t=>{const{joinedTime:n}=t;e.myRoomJoinTime=n,NAF.log.write("Successfully joined room",e.room,"at server time",n),e.connectSuccess(e.myId)})),t.on("error",(t=>{console.error("Socket connection failure",t),e.connectFailure()})),t.on("occupantsChanged",(t=>{const{occupants:n}=t;NAF.log.write("occupants changed",t),e.receivedOccupants(n)})),t.on("send",n),t.on("broadcast",n)}))}joinRoom(){NAF.log.write("Joining room",this.room),this.socket.emit("joinRoom",{room:this.room})}receivedOccupants(e){delete e[this.myId],this.occupants=e,this.occupantListener(e)}shouldStartConnectionTo(e){return!0}startStreamConnection(e){this.connectedClients.push(e),this.openListener(e)}closeStreamConnection(e){this.connectedClients=this.connectedClients.filter((t=>t!=e)),this.closedListener(e)}getConnectStatus(e){return-1!=this.connectedClients.indexOf(e)?NAF.adapters.IS_CONNECTED:NAF.adapters.NOT_CONNECTED}sendData(e,t,n){this.sendDataGuaranteed(e,t,n)}sendDataGuaranteed(e,t,n){const s={from:this.myId,to:e,type:t,data:n,sending:!0};this.socket?this.socket.emit("send",s):NAF.log.warn("SocketIO socket not created yet")}broadcastData(e,t){this.broadcastDataGuaranteed(e,t)}broadcastDataGuaranteed(e,t){const n={from:this.myId,type:e,data:t,broadcasting:!0};this.socket?this.socket.emit("broadcast",n):NAF.log.warn("SocketIO socket not created yet")}getMediaStream(e){}updateTimeOffset(){const e=Date.now()+this.avgTimeOffset;return fetch(document.location.href,{method:"HEAD",cache:"no-cache"}).then((t=>{var n=new Date(t.headers.get("Date")).getTime()+500,s=Date.now(),i=n+(s-e)/2-s;this.serverTimeRequests++,this.serverTimeRequests<=10?this.timeOffsets.push(i):this.timeOffsets[this.serverTimeRequests%10]=i,this.avgTimeOffset=this.timeOffsets.reduce(((e,t)=>e+t),0)/this.timeOffsets.length,this.serverTimeRequests>10?setTimeout((()=>this.updateTimeOffset()),3e5):this.updateTimeOffset()}))}getServerTime(){return(new Date).getTime()+this.avgTimeOffset}disconnect(){this.socket.disconnect()}}},9984:e=>{class t{constructor(e,t,n){this.localId=e,this.remoteId=t,this.sendSignalFunc=n,this.open=!1,this.channelLabel="networked-aframe-channel",this.pc=this.createPeerConnection(),this.channel=null}setDatachannelListeners(e,t,n,s){this.openListener=e,this.closedListener=t,this.messageListener=n,this.trackListener=s}offer(e){const t=this;this.setupChannel(this.pc.createDataChannel(this.channelLabel,{reliable:!1})),e.sendAudio&&e.localAudioStream.getTracks().forEach((n=>t.pc.addTrack(n,e.localAudioStream))),this.pc.createOffer((e=>{t.handleSessionDescription(e)}),(e=>{NAF.log.error("WebRtcPeer.offer: "+e)}),{offerToReceiveAudio:!0,offerToReceiveVideo:!1})}handleSignal(e){if(this.localId===e.to&&this.remoteId===e.from)switch(e.type){case"offer":this.handleOffer(e);break;case"answer":this.handleAnswer(e);break;case"candidate":this.handleCandidate(e);break;default:NAF.log.error("WebRtcPeer.handleSignal: Unknown signal type "+e.type)}}send(e,t){null!==this.channel&&"open"===this.channel.readyState&&this.channel.send(JSON.stringify({type:e,data:t}))}getStatus(){if(null===this.channel)return t.NOT_CONNECTED;switch(this.channel.readyState){case"open":return t.IS_CONNECTED;case"connecting":return t.CONNECTING;default:return t.NOT_CONNECTED}}createPeerConnection(){const e=this,n=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.msRTCPeerConnection;if(void 0===n)throw new Error("WebRtcPeer.createPeerConnection: This browser does not seem to support WebRTC.");const s=new n({iceServers:t.ICE_SERVERS});return s.onicecandidate=function(t){t.candidate&&e.sendSignalFunc({from:e.localId,to:e.remoteId,type:"candidate",sdpMLineIndex:t.candidate.sdpMLineIndex,candidate:t.candidate.candidate})},s.oniceconnectionstatechange=function(){e.open&&"disconnected"===s.iceConnectionState&&(e.open=!1,e.closedListener(e.remoteId))},s.ontrack=t=>{e.trackListener(e.remoteId,t.streams[0])},s}setupChannel(e){const t=this;this.channel=e,this.channel.onmessage=function(e){const n=JSON.parse(e.data);t.messageListener(t.remoteId,n.type,n.data)},this.channel.onopen=function(e){t.open=!0,t.openListener(t.remoteId)},this.channel.onclose=function(e){t.open&&(t.open=!1,t.closedListener(t.remoteId))},this.channel.onerror=function(e){NAF.log.error("WebRtcPeer.channel.onerror: "+e)}}handleOffer(e){const t=this;this.pc.ondatachannel=function(e){t.setupChannel(e.channel)},this.setRemoteDescription(e),this.pc.createAnswer((function(e){t.handleSessionDescription(e)}),(function(e){NAF.log.error("WebRtcPeer.handleOffer: "+e)}))}handleAnswer(e){this.setRemoteDescription(e)}handleCandidate(e){const t=window.RTCIceCandidate||window.webkitRTCIceCandidate||window.mozRTCIceCandidate;this.pc.addIceCandidate(new t(e),(function(){}),(function(e){NAF.log.error("WebRtcPeer.handleCandidate: "+e)}))}handleSessionDescription(e){this.pc.setLocalDescription(e,(function(){}),(function(e){NAF.log.error("WebRtcPeer.handleSessionDescription: "+e)})),this.sendSignalFunc({from:this.localId,to:this.remoteId,type:e.type,sdp:e.sdp})}setRemoteDescription(e){const t=window.RTCSessionDescription||window.webkitRTCSessionDescription||window.mozRTCSessionDescription||window.msRTCSessionDescription;this.pc.setRemoteDescription(new t(e),(function(){}),(function(e){NAF.log.error("WebRtcPeer.setRemoteDescription: "+e)}))}close(){this.pc&&this.pc.close()}}t.IS_CONNECTED="IS_CONNECTED",t.CONNECTING="CONNECTING",t.NOT_CONNECTED="NOT_CONNECTED",t.ICE_SERVERS=[{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"}],e.exports=class{constructor(){void 0===io&&console.warn("It looks like socket.io has not been loaded before WebrtcAdapter. Please do that."),this.app="default",this.room="default",this.occupantListener=null,this.myRoomJoinTime=null,this.myId=null,this.peers={},this.occupants={},this.audioStreams={},this.pendingAudioRequest={},this.serverTimeRequests=0,this.timeOffsets=[],this.avgTimeOffset=0}setServerUrl(e){this.wsUrl=e}setApp(e){this.app=e}setRoom(e){this.room=e}setWebRtcOptions(e){!1===e.datachannel&&NAF.log.error("WebrtcAdapter.setWebRtcOptions: datachannel must be true."),!0===e.audio&&(this.sendAudio=!0),!0===e.video&&NAF.log.warn("WebrtcAdapter does not support video yet.")}setServerConnectListeners(e,t){this.connectSuccess=e,this.connectFailure=t}setRoomOccupantListener(e){this.occupantListener=e}setDataChannelListeners(e,t,n){this.openListener=e,this.closedListener=t,this.messageListener=n}connect(){const e=this;this.updateTimeOffset().then((()=>{e.wsUrl&&"/"!==e.wsUrl||("https:"===location.protocol?e.wsUrl="wss://"+location.host:e.wsUrl="ws://"+location.host),NAF.log.write("Attempting to connect to socket.io");const t=e.socket=io(e.wsUrl);function n(t){const n=t.from,s=t.type,i=t.data;"ice-candidate"!==s?e.messageListener(n,s,i):e.peers[n].handleSignal(i)}t.on("connect",(()=>{NAF.log.write("User connected",t.id),e.myId=t.id,e.joinRoom()})),t.on("connectSuccess",(t=>{const{joinedTime:n}=t;if(e.myRoomJoinTime=n,NAF.log.write("Successfully joined room",e.room,"at server time",n),e.sendAudio){const t={audio:!0,video:!1};navigator.mediaDevices.getUserMedia(t).then((t=>{e.storeAudioStream(e.myId,t),e.connectSuccess(e.myId),t.getTracks().forEach((n=>{Object.keys(e.peers).forEach((s=>{e.peers[s].pc.addTrack(n,t)}))}))})).catch((t=>{NAF.log.error(t),console.error("Microphone is disabled due to lack of permissions"),e.sendAudio=!1,e.connectSuccess(e.myId)}))}else e.connectSuccess(e.myId)})),t.on("error",(t=>{console.error("Socket connection failure",t),e.connectFailure()})),t.on("occupantsChanged",(t=>{const{occupants:n}=t;NAF.log.write("occupants changed",t),e.receivedOccupants(n)})),t.on("send",n),t.on("broadcast",n)}))}joinRoom(){NAF.log.write("Joining room",this.room),this.socket.emit("joinRoom",{room:this.room})}receivedOccupants(e){delete e[this.myId],this.occupants=e;const n=this,s=this.myId;for(let i in e){const e=i;if(this.peers[e])continue;const o=new t(s,e,(t=>{n.socket.emit("send",{from:s,to:e,type:"ice-candidate",data:t,sending:!0})}));o.setDatachannelListeners(n.openListener,n.closedListener,n.messageListener,n.trackListener.bind(n)),n.peers[e]=o}this.occupantListener(e)}shouldStartConnectionTo(e){return(this.myRoomJoinTime||0)<=(e||0)}startStreamConnection(e){NAF.log.write("starting offer process"),this.sendAudio?this.getMediaStream(this.myId).then((t=>{const n={sendAudio:!0,localAudioStream:t};this.peers[e].offer(n)})):this.peers[e].offer({})}closeStreamConnection(e){NAF.log.write("closeStreamConnection",e,this.peers),this.peers[e].close(),delete this.peers[e],delete this.occupants[e],this.closedListener(e)}getConnectStatus(e){const n=this.peers[e];if(void 0===n)return NAF.adapters.NOT_CONNECTED;switch(n.getStatus()){case t.IS_CONNECTED:return NAF.adapters.IS_CONNECTED;case t.CONNECTING:return NAF.adapters.CONNECTING;case t.NOT_CONNECTED:default:return NAF.adapters.NOT_CONNECTED}}sendData(e,t,n){this.peers[e].send(t,n)}sendDataGuaranteed(e,t,n){const s={from:this.myId,to:e,type:t,data:n,sending:!0};this.socket.emit("send",s)}broadcastData(e,t){for(let n in this.peers)this.sendData(n,e,t)}broadcastDataGuaranteed(e,t){const n={from:this.myId,type:e,data:t,broadcasting:!0};this.socket.emit("broadcast",n)}storeAudioStream(e,t){this.audioStreams[e]=t,this.pendingAudioRequest[e]&&(NAF.log.write("Received pending audio for "+e),this.pendingAudioRequest[e](t),this.pendingAudioRequest[e](t))}trackListener(e,t){this.storeAudioStream(e,t)}getMediaStream(e){const t=this;return this.audioStreams[e]?(NAF.log.write("Already had audio for "+e),Promise.resolve(this.audioStreams[e])):(NAF.log.write("Waiting on audio for "+e),new Promise((n=>{t.pendingAudioRequest[e]=n})))}updateTimeOffset(){const e=Date.now()+this.avgTimeOffset;return fetch(document.location.href,{method:"HEAD",cache:"no-cache"}).then((t=>{const n=new Date(t.headers.get("Date")).getTime()+500,s=Date.now(),i=n+(s-e)/2-s;this.serverTimeRequests++,this.serverTimeRequests<=10?this.timeOffsets.push(i):this.timeOffsets[this.serverTimeRequests%10]=i,this.avgTimeOffset=this.timeOffsets.reduce(((e,t)=>e+t),0)/this.timeOffsets.length,this.serverTimeRequests>10?setTimeout((()=>this.updateTimeOffset()),3e5):this.updateTimeOffset()}))}getServerTime(){return(new Date).getTime()+this.avgTimeOffset}}},5474:(e,t,n)=>{var s=n(2956);AFRAME.registerComponent("networked-audio-source",{schema:{streamName:{default:"audio"},positional:{default:!0},distanceModel:{default:"inverse",oneOf:["linear","inverse","exponential"]},maxDistance:{default:1e4},refDistance:{default:1},rolloffFactor:{default:1}},init:function(){this.listener=null,this.stream=null,this._setMediaStream=this._setMediaStream.bind(this),NAF.utils.getNetworkedEntity(this.el).then((e=>{const t=e.components.networked.data.owner;t&&NAF.connection.adapter.getMediaStream(t,this.data.streamName).then(this._setMediaStream).catch((e=>s.log.error(`Error getting media stream for ${t}`,e)))}))},update(){this._setPannerProperties()},_setMediaStream(e){if(this.sound||this.setupSound(),e!=this.stream){if(this.stream&&this.sound.disconnect(),e){/chrome/i.test(navigator.userAgent)&&(this.audioEl=new Audio,this.audioEl.setAttribute("autoplay","autoplay"),this.audioEl.setAttribute("playsinline","playsinline"),this.audioEl.srcObject=e,this.audioEl.volume=0);const t=this.sound.context.createMediaStreamSource(e);this.sound.setNodeSource(t),this.el.emit("sound-source-set",{soundSource:t})}this.stream=e}},_setPannerProperties(){this.sound&&this.data.positional&&(this.sound.setDistanceModel(this.data.distanceModel),this.sound.setMaxDistance(this.data.maxDistance),this.sound.setRefDistance(this.data.refDistance),this.sound.setRolloffFactor(this.data.rolloffFactor))},remove:function(){this.sound&&(this.el.removeObject3D(this.attrName),this.stream&&this.sound.disconnect(),this.audioEl&&(this.audioEl.pause(),this.audioEl.srcObject=null,this.audioEl.load(),this.audioEl=null))},setupSound:function(){var e=this.el,t=e.sceneEl;this.sound&&e.removeObject3D(this.attrName),t.audioListener||(t.audioListener=new THREE.AudioListener,t.camera&&t.camera.add(t.audioListener),t.addEventListener("camera-set-active",(function(e){e.detail.cameraEl.getObject3D("camera").add(t.audioListener)}))),this.listener=t.audioListener,this.sound=this.data.positional?new THREE.PositionalAudio(this.listener):new THREE.Audio(this.listener),e.setObject3D(this.attrName,this.sound),this._setPannerProperties()}})},1715:()=>{AFRAME.registerComponent("networked-scene",{schema:{serverURL:{default:"/"},app:{default:"default"},room:{default:"default"},connectOnLoad:{default:!0},onConnect:{default:"onConnect"},adapter:{default:"wseasyrtc"},audio:{default:!1},video:{default:!1},debug:{default:!1}},init:function(){var e=this.el;this.connect=this.connect.bind(this),e.addEventListener("connect",this.connect),this.data.connectOnLoad&&e.emit("connect",null,!1)},connect:function(){return NAF.log.setDebug(this.data.debug),NAF.log.write("Networked-Aframe Connecting..."),this.checkDeprecatedProperties(),this.setupNetworkAdapter(),this.hasOnConnectFunction()&&this.callOnConnect(),NAF.connection.connect(this.data.serverURL,this.data.app,this.data.room,this.data.audio,this.data.video)},checkDeprecatedProperties:function(){},setupNetworkAdapter:function(){var e=this.data.adapter,t=NAF.adapters.make(e);NAF.connection.setNetworkAdapter(t),this.el.emit("adapter-ready",t,!1)},hasOnConnectFunction:function(){return""!=this.data.onConnect&&window[this.data.onConnect]},callOnConnect:function(){NAF.connection.onConnect(window[this.data.onConnect])},remove:function(){NAF.log.write("networked-scene disconnected"),this.el.removeEventListener("connect",this.connect),NAF.connection.disconnect()}})},9764:(e,t,n)=>{var s=n(2956);AFRAME.registerComponent("networked-video-source",{schema:{streamName:{default:"video"}},dependencies:["material"],init:function(){this.videoTexture=null,this.video=null,this.stream=null,this._setMediaStream=this._setMediaStream.bind(this),NAF.utils.getNetworkedEntity(this.el).then((e=>{const t=e.components.networked.data.owner;t&&NAF.connection.adapter.getMediaStream(t,this.data.streamName).then(this._setMediaStream).catch((e=>s.log.error(`Error getting media stream for ${t}`,e)))}))},_setMediaStream(e){if(this.video||this.setupVideo(),e!=this.stream){if(this.stream&&this._clearMediaStream(),e){this.video.srcObject=e;const t=this.video.play();t instanceof Promise&&t.catch((e=>s.log.error("Error play video stream",e))),this.videoTexture&&this.videoTexture.dispose(),this.videoTexture=new THREE.VideoTexture(this.video);const n=this.el.getObject3D("mesh");n.material.map=this.videoTexture,n.material.needsUpdate=!0}this.stream=e}},_clearMediaStream(){if(this.stream=null,this.videoTexture){if(this.videoTexture.image instanceof HTMLVideoElement){const e=this.videoTexture.image;e.pause(),e.srcObject=null,e.load()}this.videoTexture.dispose(),this.videoTexture=null}},remove:function(){this._clearMediaStream()},setupVideo:function(){if(!this.video){const e=document.createElement("video");e.setAttribute("autoplay",!0),e.setAttribute("playsinline",!0),e.setAttribute("muted",!0),this.video=e}}})},4467:(e,t,n)=>{var s=n(7571),i=n(4586),o=THREE.Math.DEG2RAD,r=["position","rotation","scale"];function a(e){return!(!e.isVector3||isNaN(e.x)||isNaN(e.y)||isNaN(e.z)||null===e.x||null===e.y||null===e.z)}var c,h=(c=0,function(e,t){var n=Date.now();n-c>t&&(c=n,e())});function d(){NAF.log.warn("Received invalid network update.")}AFRAME.registerSystem("networked",{init(){this.components=[],this.nextSyncTime=0},register(e){this.components.push(e)},deregister(e){const t=this.components.indexOf(e);t>-1&&this.components.splice(t,1)},tick:function(){if(!NAF.connection.adapter)return;if(this.el.clock.elapsedTime<this.nextSyncTime)return;const e={d:[]};for(let t=0,n=this.components.length;t<n;t++){const n=this.components[t];if(!n.isMine())continue;if(!n.el.parentElement)return void NAF.log.error("entity registered with system despite being removed");const s=this.components[t].syncDirty();s&&e.d.push(s)}e.d.length>0&&NAF.connection.broadcastData("um",e),this.updateNextSyncTime()},updateNextSyncTime(){this.nextSyncTime=this.el.clock.elapsedTime+1/NAF.options.updateRate}}),AFRAME.registerComponent("networked",{schema:{template:{default:""},attachTemplateToLocal:{default:!0},persistent:{default:!1},networkId:{default:""},owner:{default:""},creator:{default:""}},init:function(){this.OWNERSHIP_GAINED="ownership-gained",this.OWNERSHIP_CHANGED="ownership-changed",this.OWNERSHIP_LOST="ownership-lost",this.onOwnershipGainedEvent={el:this.el},this.onOwnershipChangedEvent={el:this.el},this.onOwnershipLostEvent={el:this.el},this.conversionEuler=new THREE.Euler,this.conversionEuler.order="YXZ",this.bufferInfos=[],this.bufferPosition=new THREE.Vector3,this.bufferQuaternion=new THREE.Quaternion,this.bufferScale=new THREE.Vector3;var e=this.wasCreatedByNetwork();let t;this.onConnected=this.onConnected.bind(this),this.syncData={},this.componentSchemas=NAF.schemas.getComponents(this.data.template),this.cachedElements=new Array(this.componentSchemas.length),this.networkUpdatePredicates=this.componentSchemas.map((e=>e.requiresNetworkUpdate&&e.requiresNetworkUpdate()||function(){let e=null;return t=>!(null!==e&&s(e,t)||(e=AFRAME.utils.clone(t),0))}())),this.invalidateCachedElements(),this.initNetworkParent(),""===this.data.networkId?(t=NAF.utils.createNetworkId(),this.el.setAttribute(this.name,{networkId:t})):t=this.data.networkId,this.el.id||this.el.setAttribute("id","naf-"+t),e?this.firstUpdate():(this.data.attachTemplateToLocal&&this.attachTemplateToLocal(),this.registerEntity(this.data.networkId)),this.lastOwnerTime=-1,NAF.clientId?this.onConnected():document.body.addEventListener("connected",this.onConnected,!1),document.body.dispatchEvent(this.entityCreatedEvent()),this.el.dispatchEvent(new CustomEvent("instantiated",{detail:{el:this.el}})),this.el.sceneEl.systems.networked.register(this)},attachTemplateToLocal:function(){const e=NAF.schemas.getCachedTemplate(this.data.template),t=e.attributes;for(let e=0;e<t.length;e++)this.el.setAttribute(t[e].name,t[e].value);for(;e.firstElementChild;)this.el.appendChild(e.firstElementChild)},takeOwnership:function(){const e=this.data.owner,t=this.lastOwnerTime,n=NAF.connection.getServerTime();return!!(e&&!this.isMine()&&t<n)&&(this.lastOwnerTime=n,this.removeLerp(),this.el.setAttribute("networked",{owner:NAF.clientId}),this.syncAll(),this.onOwnershipGainedEvent.oldOwner=e,this.el.emit(this.OWNERSHIP_GAINED,this.onOwnershipGainedEvent),this.onOwnershipChangedEvent.oldOwner=e,this.onOwnershipChangedEvent.newOwner=NAF.clientId,this.el.emit(this.OWNERSHIP_CHANGED,this.onOwnershipChangedEvent),!0)},wasCreatedByNetwork:function(){return!!this.el.firstUpdateData},initNetworkParent:function(){var e=this.el.parentElement;e.components&&e.components.networked?this.parent=e:this.parent=null},registerEntity:function(e){NAF.entities.registerEntity(e,this.el)},applyPersistentFirstSync:function(){const{networkId:e}=this.data,t=NAF.entities.getPersistentFirstSync(e);t&&(this.networkUpdate(t),NAF.entities.forgetPersistentFirstSync(e))},firstUpdate:function(){var e=this.el.firstUpdateData;this.networkUpdate(e)},onConnected:function(){""===this.data.owner&&(this.lastOwnerTime=NAF.connection.getServerTime(),this.el.setAttribute(this.name,{owner:NAF.clientId,creator:NAF.clientId}),setTimeout((()=>{this.el.parentNode?this.syncAll(void 0,!0):NAF.log.warn("Networked element was removed before ever getting the chance to syncAll")}),0)),document.body.removeEventListener("connected",this.onConnected,!1)},isMine:function(){return this.data.owner===NAF.clientId},createdByMe:function(){return this.data.creator===NAF.clientId},tick:function(e,t){if(!this.isMine()&&NAF.options.useLerp)for(var n=0;n<this.bufferInfos.length;n++){var s=this.bufferInfos[n],i=s.buffer,o=s.object3D,r=s.componentNames;if(i.update(t),r.includes("position")){const e=i.getPosition();a(e)?o.position.copy(e):h(d,5e3)}if(r.includes("rotation")){const e=i.getQuaternion();!(c=e).isQuaternion||isNaN(c.x)||isNaN(c.y)||isNaN(c.z)||isNaN(c.w)||null===c.x||null===c.y||null===c.z||null===c.w?h(d,5e3):o.quaternion.copy(e)}if(r.includes("scale")){const e=i.getScale();a(e)?o.scale.copy(e):h(d,5e3)}}var c},syncAll:function(e,t){if(this.canSync()){var n=this.gatherComponentsData(!0),s=this.createSyncData(n,t);e?NAF.connection.sendDataGuaranteed(e,"u",s):NAF.connection.broadcastDataGuaranteed("u",s)}},syncDirty:function(){if(this.canSync()){var e=this.gatherComponentsData(!1);if(null!==e)return this.createSyncData(e)}},getCachedElement(e){var t=this.cachedElements[e];if(t)return t;var n=this.componentSchemas[e];return n.selector?this.cachedElements[e]=this.el.querySelector(n.selector):this.cachedElements[e]=this.el},invalidateCachedElements(){for(var e=0;e<this.cachedElements.length;e++)this.cachedElements[e]=null},gatherComponentsData:function(e){for(var t=null,n=0;n<this.componentSchemas.length;n++){var s=this.componentSchemas[n],i=this.getCachedElement(n);if(i){var o=s.component?s.component:s,r=i.getAttribute(o);if(null!==r){var a=s.property?r[s.property]:r;(this.networkUpdatePredicates[n](a)||e)&&((t=t||{})[n]=a)}else e&&((t=t||{})[n]=null)}else e&&((t=t||{})[n]=null)}return t},createSyncData:function(e,t){var{syncData:n,data:s}=this;return n.networkId=s.networkId,n.owner=s.owner,n.creator=s.creator,n.lastOwnerTime=this.lastOwnerTime,n.template=s.template,n.persistent=s.persistent,n.parent=this.getParentId(),n.components=e,n.isFirstSync=!!t,n},canSync:function(){if(this.data.owner&&this.isMine())return!0;if(!this.createdByMe())return!1;const e=NAF.connection.getConnectedClients();for(let t in e)if(t===this.data.owner)return!1;return!0},getParentId:function(){return this.initNetworkParent(),this.parent?this.parent.getAttribute("networked").networkId:null},networkUpdate:function(e){if(!(e.lastOwnerTime<this.lastOwnerTime||this.lastOwnerTime===e.lastOwnerTime&&this.data.owner>e.owner)&&void 0!==this.data){if(this.data.owner!==e.owner){var t=this.isMine();this.lastOwnerTime=e.lastOwnerTime;const n=this.data.owner,s=e.owner;this.el.setAttribute("networked",{owner:e.owner}),t&&(this.onOwnershipLostEvent.newOwner=s,this.el.emit(this.OWNERSHIP_LOST,this.onOwnershipLostEvent)),this.onOwnershipChangedEvent.oldOwner=n,this.onOwnershipChangedEvent.newOwner=s,this.el.emit(this.OWNERSHIP_CHANGED,this.onOwnershipChangedEvent)}this.data.persistent!==e.persistent&&this.el.setAttribute("networked",{persistent:e.persistent}),this.updateNetworkedComponents(e.components)}},updateNetworkedComponents:function(e){for(var t=0,n=this.componentSchemas.length;t<n;t++){var s=e[t],i=this.componentSchemas[t],o=this.getCachedElement(t);null!==o&&null!=s&&(i.component?i.property?this.updateNetworkedComponent(o,i.component,i.property,s):this.updateNetworkedComponent(o,i.component,s):this.updateNetworkedComponent(o,i,s))}},updateNetworkedComponent:function(e,t,n,s){if(!NAF.options.useLerp||!r.includes(t))return void(void 0===s?e.setAttribute(t,n):e.setAttribute(t,n,s));let a;for(let t=0,n=this.bufferInfos.length;t<n;t++){const n=this.bufferInfos[t];if(n.object3D===e.object3D){a=n;break}}if(a){var c=a.componentNames;c.includes(t)||c.push(t)}else a={buffer:new i(i.MODE_LERP,.1),object3D:e.object3D,componentNames:[t]},this.bufferInfos.push(a);var h=a.buffer;switch(t){case"position":return void h.setPosition(this.bufferPosition.set(n.x,n.y,n.z));case"rotation":return this.conversionEuler.set(o*n.x,o*n.y,o*n.z),void h.setQuaternion(this.bufferQuaternion.setFromEuler(this.conversionEuler));case"scale":return void h.setScale(this.bufferScale.set(n.x,n.y,n.z))}NAF.log.error("Could not set value in interpolation buffer.",e,t,n,a)},removeLerp:function(){this.bufferInfos=[]},remove:function(){if(this.isMine()&&NAF.connection.isConnected()){var e={networkId:this.data.networkId};NAF.entities.hasEntity(this.data.networkId)?NAF.connection.broadcastDataGuaranteed("r",e):this.data.creator&&!1===NAF.connection.activeDataChannels[this.data.creator]||NAF.log.error("Removing networked entity that is not in entities array.")}NAF.entities.forgetEntity(this.data.networkId),document.body.dispatchEvent(this.entityRemovedEvent(this.data.networkId)),this.el.sceneEl.systems.networked.deregister(this)},entityCreatedEvent(){return new CustomEvent("entityCreated",{detail:{el:this.el}})},entityRemovedEvent:e=>new CustomEvent("entityRemoved",{detail:{networkId:e}})})},6684:(e,t,n)=>{n(2956),n(1715),n(4467),n(5474),n(9764)},5492:e=>{e.exports={debug:!1,updateRate:15,useLerp:!0,firstSyncSource:null,syncSource:null}},7090:e=>{e.exports.whenEntityLoaded=function(e,t){e.hasLoaded&&t(),e.addEventListener("loaded",(function(){t()}))},e.exports.createHtmlNodeFromString=function(e){var t=document.createElement("div");return t.innerHTML=e,t.firstChild},e.exports.getCreator=function(e){var t=e.components;return t.networked?t.networked.data.creator:null},e.exports.getNetworkOwner=function(e){var t=e.components;return t.networked?t.networked.data.owner:null},e.exports.getNetworkId=function(e){var t=e.components;return t.networked?t.networked.data.networkId:null},e.exports.now=function(){return Date.now()},e.exports.createNetworkId=function(){return Math.random().toString(36).substring(2,9)},e.exports.getNetworkedEntity=function(e){return new Promise(((t,n)=>{let s=e;for(;s&&s.components&&!s.components.networked;)s=s.parentNode;if(!s||!s.components||!s.components.networked)return n("Entity does not have and is not a child of an entity with the [networked] component ");s.hasLoaded?t(s):s.addEventListener("instantiated",(()=>{t(s)}),{once:!0})}))},e.exports.takeOwnership=function(e){let t=e;for(;t&&t.components&&!t.components.networked;)t=t.parentNode;if(!t||!t.components||!t.components.networked)throw new Error("Entity does not have and is not a child of an entity with the [networked] component ");return t.components.networked.takeOwnership()},e.exports.isMine=function(e){let t=e;for(;t&&t.components&&!t.components.networked;)t=t.parentNode;if(!t||!t.components||!t.components.networked)throw new Error("Entity does not have and is not a child of an entity with the [networked] component ");return!!t.components.networked.data&&t.components.networked.data.owner===NAF.clientId},e.exports.almostEqualVec3=function(e,t,n){return Math.abs(e.x-t.x)<n&&Math.abs(e.y-t.y)<n&&Math.abs(e.z-t.z)<n}}},t={};function n(s){var i=t[s];if(void 0!==i)return i.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,n),o.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";n(6684)})()})();
//# sourceMappingURL=naf-imports.237e5d4185746e09cd30.js.map